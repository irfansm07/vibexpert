<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VibeXpert - Connect With Your College</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a0f2e 25%, #2d1b4d 50%, #1a0f2e 75%, #0a0a0a 100%);
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-container {
      width: 100%;
      max-width: 420px;
      background: rgba(15, 25, 45, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(79, 116, 163, 0.2);
      border-radius: 20px;
      padding: 45px 35px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.6s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      font-size: 44px;
      font-weight: 800;
      text-align: center;
      background: linear-gradient(135deg, #4f74a3, #8da4d3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }

    .subtitle {
      text-align: center;
      color: #a0a0a0;
      font-size: 16px;
      margin-bottom: 30px;
    }

    .message {
      min-height: 20px;
      margin-bottom: 15px;
    }

    .msg {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      animation: slideDown 0.3s ease;
    }

    .msg-success {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .msg-error {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    form {
      display: none;
    }

    form.active {
      display: block;
    }

    h2 {
      font-size: 20px;
      color: #4f74a3;
      margin-bottom: 20px;
      font-weight: 600;
    }

    input {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 14px;
      border: 2px solid rgba(79, 116, 163, 0.3);
      background: rgba(20, 30, 50, 0.8);
      color: white;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: #4f74a3;
      box-shadow: 0 0 15px rgba(79, 116, 163, 0.3);
    }

    input::placeholder {
      color: #666;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #4f74a3, #8da4d3);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 20px rgba(79, 116, 163, 0.2);
      margin-top: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(79, 116, 163, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    p {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: #a0a0a0;
    }

    a {
      color: #4f74a3;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    a:hover {
      color: #8da4d3;
    }

    .gender-container {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .gender-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: #d0d0d0;
      font-size: 14px;
      font-weight: 500;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(79, 116, 163, 0.08);
      border: 1px solid rgba(79, 116, 163, 0.25);
      flex: 1;
      transition: all 0.3s ease;
    }

    .gender-label:hover {
      background: rgba(79, 116, 163, 0.15);
      border-color: #4f74a3;
    }

    input[type="radio"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #4f74a3;
      border-radius: 50%;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(79, 116, 163, 0.1), rgba(141, 164, 211, 0.1));
      transition: all 0.3s ease;
      margin: 0;
    }

    input[type="radio"]:checked {
      background: linear-gradient(135deg, #4f74a3, #8da4d3);
      border-color: #8da4d3;
      box-shadow: 0 0 20px rgba(79, 116, 163, 0.6);
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .api-status {
      text-align: center;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      font-size: 12px;
      display: none;
    }

    .api-status.online {
      background: rgba(34, 197, 94, 0.1);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.3);
      display: block;
    }

    .api-status.offline {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
      display: block;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <h1>VibeXpert</h1>
    <p class="subtitle">Connect With The Verse</p>
    
    <div id="apiStatus" class="api-status"></div>
    <div id="message" class="message"></div>

    <!-- LOGIN FORM -->
    <form id="loginForm" class="active">
      <h2>Login</h2>
      <input type="text" id="loginEmail" placeholder="Email or Registration Number" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button type="submit">Login</button>
      <p>Don't have an account? <a onclick="showSignup()">Sign Up</a></p>
      <p><a onclick="showForgotPassword()">Forgot Password?</a></p>
    </form>

    <!-- SIGNUP FORM -->
    <form id="signupForm">
      <h2>Create Account</h2>
      <input type="text" id="signupName" placeholder="Full Name" required>
      <input type="email" id="signupEmail" placeholder="College Email" required>
      <input type="text" id="signupReg" placeholder="Registration Number" required>
      
      <label style="display:block; margin:15px 0 10px 0; color:#a0a0a0; font-size:14px;">Gender</label>
      <div class="gender-container">
        <label class="gender-label">
          <input type="radio" name="gender" value="Male" required>
          üë® Male
        </label>
        <label class="gender-label">
          <input type="radio" name="gender" value="Female">
          üë© Female
        </label>
        <label class="gender-label">
          <input type="radio" name="gender" value="Other">
          üåà Other
        </label>
      </div>

      <input type="password" id="signupPass" placeholder="Password (min 6 characters)" required minlength="6">
      <input type="password" id="signupConfirm" placeholder="Confirm Password" required>
      
      <button type="submit">Create Account</button>
      <p>Already have an account? <a onclick="showLogin()">Login</a></p>
    </form>

    <!-- FORGOT PASSWORD FORM -->
    <form id="forgotForm">
      <h2>Reset Password</h2>
      
      <div id="emailSection">
        <p style="color:#888; font-size:14px; margin-bottom:15px;">
          Enter your email to receive a verification code.
        </p>
        <input type="email" id="resetEmail" placeholder="Your Email" required>
        <button type="button" onclick="sendResetCode()">üìß Send Code</button>
      </div>
      
      <div id="codeSection" style="display:none;">
        <p style="color:#888; font-size:14px; margin-bottom:15px;">
          üìß Check your email for the 6-digit code.
        </p>
        <input type="text" id="resetCode" placeholder="Enter 6-digit code" maxlength="6" required>
        <input type="password" id="newPassword" placeholder="New Password" required minlength="6">
        <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
        <button type="button" onclick="verifyResetCode()">üîì Reset Password</button>
        <button type="button" onclick="resendCode()" style="background:rgba(79,116,163,0.2); margin-top:10px;">üìß Resend Code</button>
      </div>
      
      <p><a onclick="showLogin()">‚Üê Back to Login</a></p>
    </form>
  </div>

  <script>
    // Configuration
    const API_URL = 'https://vibexpert-backend-main.onrender.com';
    const API_TIMEOUT = 30000; // 30 seconds
    let apiOnline = false;

    // Check API status on load
    async function checkAPIStatus() {
      const status = document.getElementById('apiStatus');
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${API_URL}/api/health`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (response.ok) {
          apiOnline = true;
          status.className = 'api-status online';
          status.textContent = '‚úÖ Server Connected';
          setTimeout(() => status.style.display = 'none', 3000);
        } else {
          throw new Error('Server unavailable');
        }
      } catch (error) {
        apiOnline = false;
        status.className = 'api-status offline';
        status.textContent = '‚ö†Ô∏è Server starting up... Please wait 30 seconds and try again';
        console.error('API Status:', error);
      }
    }

    // API Call with better error handling
    async function apiCall(endpoint, method = 'GET', body = null) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);
      
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json'
        },
        signal: controller.signal
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      try {
        console.log(`üì° ${method} ${endpoint}`);
        const response = await fetch(`${API_URL}${endpoint}`, options);
        clearTimeout(timeoutId);
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || data.message || 'Request failed');
        }
        
        console.log(`‚úÖ Success: ${endpoint}`);
        return data;
      } catch (error) {
        clearTimeout(timeoutId);
        console.error(`‚ùå ${endpoint}:`, error);
        
        if (error.name === 'AbortError') {
          throw new Error('Request timeout - server may be starting up. Please wait 30 seconds and try again.');
        }
        
        if (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION')) {
          throw new Error('Connection failed - server may be starting up. Please wait 30 seconds and try again.');
        }
        
        throw error;
      }
    }

    // Show message
    function showMessage(text, type) {
      const msgBox = document.getElementById('message');
      const div = document.createElement('div');
      div.className = `msg msg-${type}`;
      div.textContent = text;
      msgBox.innerHTML = '';
      msgBox.appendChild(div);
      setTimeout(() => div.remove(), 5000);
    }

    // Form switching
    function showLogin() {
      document.querySelectorAll('form').forEach(f => f.classList.remove('active'));
      document.getElementById('loginForm').classList.add('active');
    }

    function showSignup() {
      document.querySelectorAll('form').forEach(f => f.classList.remove('active'));
      document.getElementById('signupForm').classList.add('active');
    }

    function showForgotPassword() {
      document.querySelectorAll('form').forEach(f => f.classList.remove('active'));
      document.getElementById('forgotForm').classList.add('active');
      document.getElementById('emailSection').style.display = 'block';
      document.getElementById('codeSection').style.display = 'none';
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const submitBtn = e.target.querySelector('button[type="submit"]');
      
      if (!email || !password) {
        return showMessage('‚ö†Ô∏è Please fill all fields', 'error');
      }
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Logging in<span class="loading-spinner"></span>';
        showMessage('üîê Logging in...', 'success');
        
        const data = await apiCall('/api/login', 'POST', { email, password });
        
        showMessage('‚úÖ Login successful! Redirecting...', 'success');
        
        // Store auth data
        localStorage.setItem('authToken', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));
        
        // Hide auth page and show main page
        setTimeout(() => {
          document.querySelector('.auth-container').style.display = 'none';
          
          // Check if main page exists in DOM
          const mainPage = document.getElementById('mainPage');
          const aboutPage = document.getElementById('aboutUsPage');
          
          if (mainPage) {
            mainPage.style.display = 'block';
            // Initialize main app
            if (typeof initMainApp === 'function') {
              initMainApp();
            }
          } else if (aboutPage) {
            aboutPage.style.display = 'none';
            // Reload to show main page
            window.location.reload();
          } else {
            // If no main page in DOM, redirect
            window.location.href = '/';
          }
        }, 1000);
        
      } catch (error) {
        showMessage('‚ùå Login failed: ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Login';
      }
    });

    // Signup
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('signupName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const registrationNumber = document.getElementById('signupReg').value.trim();
      const gender = document.querySelector('input[name="gender"]:checked')?.value;
      const password = document.getElementById('signupPass').value;
      const confirm = document.getElementById('signupConfirm').value;
      const submitBtn = e.target.querySelector('button[type="submit"]');
      
      if (!username || !email || !registrationNumber || !gender || !password || !confirm) {
        return showMessage('‚ö†Ô∏è Please fill all fields', 'error');
      }
      
      if (password !== confirm) {
        return showMessage('‚ö†Ô∏è Passwords do not match', 'error');
      }
      
      if (password.length < 6) {
        return showMessage('‚ö†Ô∏è Password must be at least 6 characters', 'error');
      }
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Creating account<span class="loading-spinner"></span>';
        showMessage('üìù Creating account...', 'success');
        
        await apiCall('/api/register', 'POST', {
          username,
          email,
          password,
          registrationNumber,
          gender
        });
        
        showMessage('üéâ Account created! Please check your email to verify.', 'success');
        
        // Reset form
        document.getElementById('signupForm').reset();
        
        // Show login form after 3 seconds
        setTimeout(showLogin, 3000);
        
      } catch (error) {
        showMessage('‚ùå Signup failed: ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Create Account';
      }
    });

    // Send reset code
    async function sendResetCode() {
      const email = document.getElementById('resetEmail').value.trim();
      const btn = event.target;
      
      if (!email) {
        return showMessage('‚ö†Ô∏è Please enter your email', 'error');
      }
      
      try {
        btn.disabled = true;
        btn.innerHTML = 'Sending<span class="loading-spinner"></span>';
        showMessage('üìß Sending verification code...', 'success');
        
        await apiCall('/api/forgot-password', 'POST', { email });
        
        showMessage('‚úÖ Code sent! Check your email.', 'success');
        document.getElementById('emailSection').style.display = 'none';
        document.getElementById('codeSection').style.display = 'block';
        
      } catch (error) {
        showMessage('‚ùå Failed: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'üìß Send Code';
      }
    }

    // Verify reset code
    async function verifyResetCode() {
      const email = document.getElementById('resetEmail').value.trim();
      const code = document.getElementById('resetCode').value.trim();
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const btn = event.target;
      
      if (!code || code.length !== 6) {
        return showMessage('‚ö†Ô∏è Please enter the 6-digit code', 'error');
      }
      
      if (!newPassword || !confirmPassword) {
        return showMessage('‚ö†Ô∏è Please enter new password', 'error');
      }
      
      if (newPassword !== confirmPassword) {
        return showMessage('‚ö†Ô∏è Passwords do not match', 'error');
      }
      
      if (newPassword.length < 6) {
        return showMessage('‚ö†Ô∏è Password must be at least 6 characters', 'error');
      }
      
      try {
        btn.disabled = true;
        btn.innerHTML = 'Resetting<span class="loading-spinner"></span>';
        showMessage('üîê Resetting password...', 'success');
        
        await apiCall('/api/reset-password', 'POST', {
          email,
          code,
          newPassword
        });
        
        showMessage('‚úÖ Password reset successful! You can now login.', 'success');
        
        // Reset form
        document.getElementById('forgotForm').reset();
        
        // Show login form after 2 seconds
        setTimeout(showLogin, 2000);
        
      } catch (error) {
        showMessage('‚ùå Failed: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'üîì Reset Password';
      }
    }

    // Resend code
    async function resendCode() {
      const email = document.getElementById('resetEmail').value.trim();
      const btn = event.target;
      
      try {
        btn.disabled = true;
        btn.innerHTML = 'Sending<span class="loading-spinner"></span>';
        showMessage('üìß Resending code...', 'success');
        
        await apiCall('/api/forgot-password', 'POST', { email });
        
        showMessage('‚úÖ Code resent! Check your email.', 'success');
        btn.disabled = false;
        btn.innerHTML = 'üìß Resend Code';
        
      } catch (error) {
        showMessage('‚ùå Failed: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'üìß Resend Code';
      }
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ VibeXpert Auth initialized');
      checkAPIStatus();
      
      // Check if already logged in
      const token = localStorage.getItem('authToken');
      const user = localStorage.getItem('user');
      
      if (token && user) {
        showMessage('‚úÖ Already logged in. Loading...', 'success');
        
        // Check if we're in the full app
        const mainPage = document.getElementById('mainPage');
        const aboutPage = document.getElementById('aboutUsPage');
        
        if (mainPage) {
          // We're in the full app, hide auth and show main
          document.querySelector('.auth-container').style.display = 'none';
          aboutPage.style.display = 'none';
          mainPage.style.display = 'block';
          
          // Update user info
          try {
            const currentUser = JSON.parse(user);
            const userName = document.getElementById('userName');
            if (userName) userName.textContent = 'Hi, ' + currentUser.username;
            
            // Initialize socket if user has college
            if (currentUser.college && typeof initializeSocket === 'function') {
              initializeSocket();
            }
          } catch (e) {
            console.error('Parse user error:', e);
          }
        } else {
          // We're on standalone auth page, reload to get to main app
          setTimeout(() => window.location.reload(), 1000);
        }
      }
    });
  </script>
</body>
</html>
